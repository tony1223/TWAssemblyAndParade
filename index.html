<!DOCTYPE html>
<html>
<head>
  <title>集會遊行禁制區示意圖（概略版）</title>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="leaflet.css" />
  <style>
    .text-labels{
      width:200px !important;
      margin-left:-20px !important;
      color:black;
    }
  </style>
</head>
<body>
  <div id="mapid" style="width: 1000px; height: 600px"></div>


  <script src="leaflet.js"></script>
  <script   src="https://code.jquery.com/jquery-2.2.4.min.js"   integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="   crossorigin="anonymous"></script> 
  <script>




var cellsAPI = function(sid,callback){
 $.get("https://spreadsheets.google.com/feeds/cells/"+sid+"/od6/public/values?alt=json",function(json){
    console.log(json);
    var entries = json.feed.entry;
    var lines = entries.reduce(function(now,cell){
      var row = parseInt(cell.gs$cell.row,10);
      var col = parseInt(cell.gs$cell.col,10);

      now[row] = now[row] || [];
      now[row][col] = cell.gs$cell.$t;
      return now;
    },[]);
    callback(lines);
    });
    
};


    var mymap = L.map('mapid').setView([25.043325,121.5195076], 15);

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery © <a href="http://mapbox.com">Mapbox</a>',
      id: 'mapbox.streets'
    }).addTo(mymap);


    // L.marker([51.5, -0.09]).addTo(mymap)
    //   .bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();

    cellsAPI("1Fd0YPup2zzAYBzcROLH4cLixiEBLtAUmuNTJqch_PKk",function(lines){
      var locations = [];
      console.log(lines);
      for(var i = 4;i<lines.length;++i){
        locations.push({
          latlng:lines[i][2].split(","),
          title:lines[i][1],
          meters: parseInt(lines[i][3],10),
          building: parseInt(lines[i][4],10),
          polygons: lines[i][5] && JSON.parse(lines[i][5])
        });
      }

      locations.forEach(function(loc){

          L.marker(loc.latlng, {
              icon: L.divIcon({
                  className: 'text-labels',   // Set class for CSS styling
                  html: loc.title
              }),
              zIndexOffset: 1000     // Make appear above other map features
          }).addTo(mymap);        
          L.circle(loc.latlng, loc.building || 20 /* 因為標準是在院體外，不是跟建築物中心距離，所以補一點，不會太精準。 */, {
            color: 'gray',
            title:loc.title,
            fillColor: '#f03',
            fillOpacity: 0.5
          }).addTo(mymap).bindPopup(loc.title);
          // L.marker(loc.latlng,{title:loc.title}).addTo(mymap)
          // .bindPopup(loc.title)

          if(loc.polygons){

            L.polygon(loc.polygons, {
              color: 'red',
              fillColor: '#f03',
              fillOpacity: 0.5
            }).addTo(mymap).bindPopup(loc.title+" 的禁制區");
          }else{
            L.circle(loc.latlng, (loc.meters||30) +(loc.building||20) /* 因為標準是在院體外，不是跟建築物中心距離，所以可能不會太精準。 */, {
              color: 'red',
              fillColor: '#f03',
              fillOpacity: 0.5
            }).addTo(mymap).bindPopup(loc.title+" 的禁制區");
          }
      });
    });

    // https://docs.google.com/spreadsheets/d/1Fd0YPup2zzAYBzcROLH4cLixiEBLtAUmuNTJqch_PKk/edit#gid=0


    // function onMapClick(e) {
    //   popup
    //     .setLatLng(e.latlng)
    //     .setContent("You clicked the map at " + e.latlng.toString())
    //     .openOn(mymap);
    // }

    // mymap.on('click', onMapClick);

  </script>
</body>
</html>
